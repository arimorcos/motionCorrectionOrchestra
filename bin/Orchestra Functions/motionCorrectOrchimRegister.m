function motionCorrectOrchimRegister(tiffLoc, refFrameID, tiffInfo, testInd,...
    outName)
%motionCorrectOrch.m Calculates x and y shifts to minimize motion between a
%test frame and a reference frame. Optimized for the Orchestra cluster at
%HMS.
%
%INPUTS
%tiffLoc - filename (including path) of tiff
%refFrameID - index of reference frame
%tiffInfo - info file generated by iminfo
%testInd - array containing index of frame(s) to test
%outName - file name and path for .mat file to be saved
%
%OUTPUT
%no output but saves a file with xShifts and yShifts with '_frameID,'
%appended
%
%ASM 9/13/13 based off of track_subpixel_wholeframe_motion_varythresh CDH

%store number of comparisons
nComp = length(testInd);

%load reference frame
refFrame = loadtiffAM(tiffLoc);

%get frame size
[height, width] = size(refFrame);

%create testFrame array and load in testFrames
testFrames = loadtiffAM(tiffLoc,testInd);

%generate optimizer and metric
[optimizer,metric] = imregconfig('monomodal');
optimizer.MaximumStepLength = 0.01;
optimizer.RelaxationFactor = 0.8;

%duplicate refFrame
refFrame = repmat(refFrame,[1,1,nComp]);

%perform registration
shiftFrames = imregister(testFrames,refFrame,'affine',optimizer,metric);

%store shiftInd for re-indexing
shiftInd = testInd;

%save relevant variables
save(outName,'shiftInd','shiftFrames');

end